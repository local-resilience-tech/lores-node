services:
  lores-frontend:
    image: lores-frontend-dev
    ports:
      - "5173:5173"
    environment:
      - VITE_API_HOST=http://lores.localhost:8200
    volumes:
      - ./frontend/src:/app/src
  lores-node:
    image: lores-node-dev
    networks:
      - proxy
    ports:
      - "8200:8200"
      - "2022:2022/udp"
      - "2023:2023/udp"
    environment:
      - FRONTEND_PATH=/app/frontend
      - DATABASE_URL=sqlite:/app/projections.sqlite
      - NODE_DATA_DATABASE_URL=sqlite:/app/node_data.sqlite
      - OPERATION_DATABASE_URL=sqlite:/app/operations.sqlite
      - CONFIG_PATH=/app/config.toml
      - APP_REPOS_PATH=/app/app_repos
      - APPS_PATH=/app/apps
      - BASE_URL=http://lores.localhost:5173
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./backend/data/app_repos:/app/app_repos
      - ./backend/data/apps:/app/apps
  traefik:
    logging:
      options:
        max-size: "1m"
    image: traefik:3.2
    networks:
      - proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "80:80"
      - "443:443"
    command:
      - --accesslog=true
      # Possible log levels: DEBUG, INFO, WARN, ERROR (default), FATAL, PANIC
      - --log.level=INFO
      # Use your favourite settings here, but add:
      - --providers.swarm.network=lores
      - --providers.swarm.watch
      - --providers.swarm.exposedByDefault=false
      # By default a traefiek-enabled service can be accessed at
      # https://stackName.TOP_DOMAIN (where TOP_DOMAIN is specified at
      # the proxy stack's create time, or set to 'localhost' by default.
      - --providers.swarm.defaultRule=Host(`lores.localhost`)
      - --api
      - --entryPoints.web.address=:80
networks:
  proxy:
    name: lores
    driver: overlay
    attachable: true
